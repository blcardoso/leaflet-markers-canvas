!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("leaflet"),require("rbush")):"function"==typeof define&&define.amd?define(["leaflet","rbush"],t):t((e=e||self).L,e.RBush)}(this,function(o,e){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o;var t={_map:null,_canvas:null,_context:null,_markers:[],_markersTree:new(e=e&&e.hasOwnProperty("default")?e.default:e),_positionsTree:new e,_icons:{},addTo:function(e){return e.addLayer(this),this},getBounds:function(){var t=new o.LatLngBounds;return this._markers.forEach(function(e){t.extend(e.getLatLng())}),t},redraw:function(){this._redraw(!0)},clear:function(){this._positionsTree=new e,this._markersTree=new e,this._markers=[],this._redraw(!0)},addMarker:function(e){var e=this._addMarker(e),t=e.markerBox,i=e.positionBox,e=e.isVisible;t&&e&&this._markersTree.insert(t),i&&this._positionsTree.insert(i)},addMarkers:function(e){var s=this,a=[],n=[];e.forEach(function(e){var e=s._addMarker(e),t=e.markerBox,i=e.positionBox,e=e.isVisible;t&&e&&a.push(t),i&&n.push(i)}),this._markersTree.load(a),this._positionsTree.load(n)},removeMarker:function(e){var t=e.getLatLng(),i=this._map.getBounds().contains(t),t={minX:t.lng,minY:t.lat,maxX:t.lng,maxY:t.lat,marker:e};this._positionsTree.remove(t,function(e,t){return e.marker._leaflet_id===t.marker._leaflet_id}),i&&this._redraw(!0)},removeMarkers:function(e){var s=this,a=!1;e.forEach(function(e){var t=e.getLatLng(),i=s._map.getBounds().contains(t),t={minX:t.lng,minY:t.lat,maxX:t.lng,maxY:t.lat,marker:e};s._positionsTree.remove(t,function(e,t){return e.marker._leaflet_id===t.marker._leaflet_id}),i&&(a=!0)}),a&&this._redraw(!0)},initialize:function(e){o.Util.setOptions(this,e)},onAdd:function(e){this._map=e,this._initCanvas(),this.getPane().appendChild(this._canvas),e.on("moveend",this._reset,this),e.on("resize",this._reset,this),e.on("click",this._fire,this),e.on("mousemove",this._fire,this),e._zoomAnimated&&e.on("zoomanim",this._animateZoom,this)},onRemove:function(e){this.getPane().removeChild(this._canvas),e.off("click",this._fire,this),e.off("mousemove",this._fire,this),e.off("moveend",this._reset,this),e.off("resize",this._reset,this),e._zoomAnimated&&e.off("zoomanim",this._animateZoom,this)},setOptions:function(e){return o.Util.setOptions(this,e),this.redraw()},_initCanvas:function(){var e=this._map.getSize(),t=e.x,e=e.y,i=this._map.options.zoomAnimation&&o.Browser.any3d;this._canvas=o.DomUtil.create("canvas","leaflet-markers-canvas-layer leaflet-layer"),this._canvas.width=t,this._canvas.height=e,this._context=this._canvas.getContext("2d"),o.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(i?"animated":"hide"))},_addMarker:function(e){if("markerPane"!==e.options.pane||!e.options.icon)return console.error("This is not a marker",e),{markerBox:null,positionBox:null,isVisible:null};e._map=this._map,o.Util.stamp(e);var t=e.getLatLng(),i=this._map.getBounds().contains(t),s=this._map.latLngToContainerPoint(t),a=s.x,s=s.y,n=e.options.icon.options,r=n.iconSize,n=n.iconAnchor,r={minX:a-n[0],minY:s-n[1],maxX:a+r[0]-n[0],maxY:s+r[1]-n[1],marker:e},n={minX:t.lng,minY:t.lat,maxX:t.lng,maxY:t.lat,marker:e};return i&&this._drawMarker(e,{x:a,y:s}),this._markers.push(e),{markerBox:r,positionBox:n,isVisible:i}},_drawMarker:function(e,t){var i,s=this,a=t.x,t=t.y,n=e.options.icon.options.iconUrl;e.image?this._drawImage(e,{x:a,y:t}):this._icons[n]?(e.image=this._icons[n].image,this._icons[n].isLoaded?this._drawImage(e,{x:a,y:t}):this._icons[n].elements.push({marker:e,x:a,y:t})):((i=new Image).src=n,e.image=i,this._icons[n]={image:i,isLoaded:!1,elements:[{marker:e,x:a,y:t}]},i.onload=function(){s._icons[n].isLoaded=!0,s._icons[n].elements.forEach(function(e){var t=e.marker,i=e.x,e=e.y;s._drawImage(t,{x:i,y:e})})})},_drawImage:function(e,t){var i=t.x,t=t.y,s=e.options.icon.options,a=s.rotationAngle,n=s.iconAnchor,s=s.iconSize,a=a||0;this._context.save(),this._context.translate(i,t),this._context.rotate(a*Math.PI/180),this._context.drawImage(e.image,-n[0],-n[1],s[0],s[1]),this._context.restore()},_redraw:function(e){var n,r=this;e&&this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._map&&this._positionsTree&&(e={minX:(e=this._map.getBounds()).getWest(),minY:e.getSouth(),maxX:e.getEast(),maxY:e.getNorth()},n=[],this._positionsTree.search(e).forEach(function(e){var e=e.marker,t=e.getLatLng(),t=r._map.latLngToContainerPoint(t),i=t.x,t=t.y,s=e.options.icon.options,a=s.iconSize,s=s.iconAnchor,a={minX:i-s[0],minY:t-s[1],maxX:i+a[0]-s[0],maxY:t+a[1]-s[1],marker:e};n.push(a),r._drawMarker(e,{x:i,y:t})}),this._markersTree.clear(),this._markersTree.load(n))},_reset:function(){var e=this._map.containerPointToLayerPoint([0,0]),e=(o.DomUtil.setPosition(this._canvas,e),this._map.getSize()),t=e.x,e=e.y;this._canvas.width=t,this._canvas.height=e,this._redraw()},_fire:function(e){var t,i;this._markersTree&&(t=(i=e.containerPoint).x,i=i.y,(t=this._markersTree.search({minX:t,minY:i,maxX:t,maxY:i}))&&t.length?(this._map._container.style.cursor="pointer",i=t[0].marker,"click"===e.type&&i.listens("click")&&i.fire("click"),"mousemove"===e.type&&(this._mouseOverMarker&&this._mouseOverMarker!==i&&this._mouseOverMarker.listens("mouseout")&&this._mouseOverMarker.fire("mouseout"),this._mouseOverMarker&&this._mouseOverMarker===i||(this._mouseOverMarker=i).listens("mouseover")&&i.fire("mouseover"))):(this._map._container.style.cursor="","mousemove"===e.type&&this._mouseOverMarker&&(this._mouseOverMarker.listens("mouseout")&&this._mouseOverMarker.fire("mouseout"),delete this._mouseOverMarker)))},_animateZoom:function(e){var t=this._map.getZoomScale(e.zoom),e=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),e.zoom,e.center).min;o.DomUtil.setTransform(this._canvas,e,t)}};o.MarkersCanvas=o.Layer.extend(t)});
